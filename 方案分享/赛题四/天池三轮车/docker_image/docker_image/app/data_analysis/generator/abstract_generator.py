from json_repair import repair_json

import generator


def generate_abstract(intent, catalogue_content, rag_content, theme=""):
    prompt_template = '''
    请基于提供的[商汤科技] [2024]年度报告中的《管理层讨论与分析》章节，进行结构化提炼与关键信息总结。请重点关注以下方面，并以清晰、简洁、要点化的方式呈现：

    核心业绩总结 (Performance Summary):
    
    关键财务指标表现：营收、净利润、毛利率、每股收益等的主要变动（增长/下降百分比）及核心驱动因素。
    
    主要业务板块/产品线表现：各自贡献、增长亮点或下滑领域及原因。
    
    与预算/目标/上一年度的对比：是否达成预期？差异原因？
    
    管理层对整体业绩的定性评价（如：稳健、挑战、转型期等）。
    
    业务驱动因素与挑战 (Drivers & Challenges):
    
    增长驱动因素： 明确列出管理层认为推动本年度业绩增长的关键因素（例如：新产品成功、市场份额提升、成本控制、市场需求旺盛、并购整合效应、汇率有利变动等）。
    
    面临的主要挑战： 明确列出管理层指出的影响业绩或运营的重大困难、风险和不利因素（例如：市场竞争加剧、原材料成本上涨、供应链中断、监管变化、宏观经济下行、地缘政治风险、特定项目失利等）。
    
    战略重点与未来展望 (Strategy & Outlook):
    
    核心战略方向： 提炼管理层阐述的未来1-3年核心战略重点（例如：加大研发投入方向、市场扩张计划、数字化转型、降本增效措施、可持续发展举措、并购/剥离策略等）。
    
    资本配置计划： 资金的主要投向（研发、资本支出、并购、分红、回购等）。
    
    未来展望：
    
    管理层对下一报告期（下一年度/季度）的具体业绩预期或指引（如有提供）。
    
    管理层对未来行业趋势的看法及其对公司的影响。
    
    管理层对关键风险的持续关注及应对计划。
    
    管理层对实现长期目标的信心和路径简述。
    
    关键风险提示 (Key Risks):
    
    提炼管理层在本章节中着重强调的、可能对未来业绩和财务状况产生重大不利影响的主要风险（需与“挑战”区分，风险更侧重潜在未来威胁）。按重要性或类别列出。
    
    管理层基调与信心 (Tone & Confidence):
    
    基于整体表述，提炼管理层的整体基调（积极乐观、审慎保守、面临压力等）。
    
    评估管理层对未来执行战略和实现目标所展现的信心程度。
    
    输出要求：
    
    结构化呈现： 严格按上述1-5点的顺序组织内容。
    
    要点化与精炼： 使用清晰、简洁的要点（Bullet Points）形式，避免冗长段落。每条要点只包含核心信息。
    
    直接引用与归纳结合： 尽可能使用管理层原文中的关键措辞（尤其是战略、驱动因素、风险等），同时进行必要的归纳总结。重要数据（如百分比）必须准确反映。
    
    突出关键信息： 对于重要的业绩变化、核心战略、重大风险、未来预期等信息，确保清晰突出。
    
    区分事实与展望： 明确区分对过往业绩/事件的描述和对未来的预测/展望。
    
    保持客观： 忠实于报告原文，不添加个人解读或评论。
    
    以下是《管理层讨论与分析》的内容：
    ${rag_content}
    '''

    prompt = prompt_template.replace('{rag_content}', rag_content)
    result = generator.generate(prompt, False)
    repaired_json = repair_json(result, ensure_ascii=False)
    return repaired_json

