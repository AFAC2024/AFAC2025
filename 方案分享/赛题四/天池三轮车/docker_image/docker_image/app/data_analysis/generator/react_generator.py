from json_repair import repair_json

import generator


def generator_pic(intent, theme, content):
    prompt_template = '''
    ## 角色
    你是一位首席金融分析师，掌握个股研报、行业研报、宏观研报的撰写方法。你的任务是在正文中合适的位置插入图表，实现图文结合。
    
    ## 要求
    1. 在需要插图的段落末尾添加图表标签，格式“<${图表名称}end>”
    - 只允许使用所提供图表，禁止自行拓展
    - 每张图表只能插入一次，禁止重复使用
    2. JSON格式输出包含图表标签的正文内容
    - 除了添加图表标签外，禁止修改研报内容
    - 放入"content"字段，字段内使用markdown格式
    3. JSON格式直接输出最终结果，禁止添加额外说明
    
    ## 输出模版（JSON格式）
    {
        "content": ""
    }
    
    ## 研报主题
    ${report_type}：${theme}
    
    ## 研报内容
    ${report_content}
    
    ## 可用图表
    | 图表标签 | 所用金融指标名称 | 图表形式 |
    | :--- | :--- | :--- | :--- |
    | <营业总收入end> | 营业总收入 | 柱状-折线图 |
    | <盈利能力end> | 净利率、毛利率、ROE | 折线图 |
    | <偿债能力end> | 流动比率（倍）、资产负债率 | 折线图 |
    '''
    prompt = prompt_template.replace('{report_type}', intent).replace('{theme}', theme).replace('{report_content}',
                                                                                                content)
    result = generator.generate(prompt, False)
    repaired_json = repair_json(result, ensure_ascii=False)
    return repaired_json


# content = '''
# # 中国智能服务机器人产业：技术突破与政策红利驱动千亿级市场爆发
# 证券研究报告｜智能服务机器人行业分析
# 发布时间：2025-07-23
# 分析师：AI Analyst
# ## 投资要点
# **核心观点**：中国智能服务机器人产业在技术突破与政策红利双重驱动下进入高速增长期，预计2025年市场规模突破1200亿元，医疗、商用服务及工业协作机器人三大领域将形成核心增长极。

# **投资价值**：
# 1. **技术迭代加速**：多模态交互技术渗透率提升至58%（2023年），核心零部件国产化率突破75%，推动全产业链降本增效；
# 2. **政策密集支持**：2000亿元再贷款专项额度（2024年）与5000亿元新质生产力基金重点倾斜，行业年均获财政支持强度超15%；
# 3. **场景持续拓展**：医疗手术机器人市场规模突破65亿元（2023年），商用服务机器人在酒店/楼宇场景渗透率达19.3%/12.7%（2024年）。

# **风险提示**：
# - 稀土永磁材料价格波动致成本上升12%（2024Q1）；
# - 中美技术脱钩或使进口零部件关税税率提升至15%；
# - 政策补贴退坡导致企业利润率承压3-5个百分点。

# **投资建议**：重点布局医疗机器人（目标PE 45x）、高精度传感器（国产替代率28%）、具身智能技术企业，2024Q3为战略配置窗口期。
# ## 1. 全球经济复苏分化与国内稳增长政策双轮驱动行业增长
# ### 1.1 全球经济形势：增长动能分化加剧结构性挑战
# 2024年全球经济增长呈现显著分化态势，发达经济体增速放缓至1.3%，而新兴市场保持3.9%扩张（IMF，2024）。美国制造业回流政策推高核心PCE至3.2%（2024Q1），欧元区制造业PMI连续15个月低于荣枯线，驱动智能服务机器人产业链区域性重构。

# | **经济体** | **2024年GDP预测** | **货币政策基调** |
# |------------|--------------------|------------------|
# | 美国       | 2.1%               | 维持限制性利率   |
# | 欧元区     | 0.7%               | 边际宽松预期增强 |
# | 中国       | 5.0%               | 结构性工具精准发力 |
# *数据来源：IMF世界经济展望（2024年4月）*

# ### 1.2 国内经济政策：结构性工具精准灌溉战略新兴产业
# 2024年先进制造业增值税加计抵减比例提至15%，智能服务机器人纳入首批高质量发展目录。央行设立2000亿元再贷款额度支持AI与机器人融合创新，新质生产力基金30%投向服务机器人研发（2024年3月）。

# ## 2. 智能服务机器人行业进入规模化扩张新阶段
# ### 2.1 市场规模呈现指数级增长
# 2023年行业规模突破800亿元（CAGR 32.4%），商用服务机器人占比58%，预计2025年达1220亿元。技术研发投入占比从14.2%提升至16.8%（2023-2025）。

# | **关键指标**   | **2023年** | **2025年（预测）** |
# |----------------|------------|--------------------|
# | 市场规模       | 815亿元    | 1220亿元           |
# | 服务机器人渗透率 | 18.7%      | 27.5%              |
# *数据来源：国家统计局《智能制造产业发展白皮书》（2024）*

# ### 2.2 三维驱动引擎加速产业升级
# 技术层面：多模态交互系统迭代周期缩至9个月，云端算法专利增长67%；政策层面：长三角落地22个专项产业园；需求层面：养老护理机器人缺口超300万台，医疗手术机器人装机量年增45%。

# ## 3. 智能服务机器人产业链整合加速，市场集中度持续提升
# ### 3.1 产业链全景分析
# 上游高精度传感器占成本结构45%（2023年），中游优必选等企业构建多模态交互系统，下游京东物流等深耕场景化解决方案。

# | **环节**   | **代表企业**       | **技术壁垒**         |
# |------------|--------------------|----------------------|
# | 核心零部件 | 海康威视、英伟达   | 高精度运动控制算法   |
# | 本体制造   | 优必选、新松       | 多模态交互系统研发   |
# *数据来源：中国机器人产业联盟（2024）*

# ### 3.2 市场竞争格局
# CR5达68%（2023年），大疆农业机器人市占率32%，优必选教育服务领域CAGR 25%。

# ## 4. 智能服务机器人产业迎来技术突破与政策红利双重驱动
# ### 4.1 技术演进重构竞争格局
# 环境识别准确率提升至98.7%（2023年），能耗效率优化40%。光伏驱动清洁机器人市场规模突破50亿元（CAGR 37%）。

# ### 4.2 监管框架加速规范化
# 数据脱敏技术投入增长210%（2023年），85%企业建立合规部门，新版技术标准淘汰20%低端产能。

# ## 5. 行业风险因素深度解析
# ### 5.1 周期性波动风险
# 稀土永磁材料价格上涨18%推高驱动系统成本12%（2024Q1），人民币汇率波动致汇兑损失占比8-15%。

# ### 5.2 政策不确定性
# 智能制造补贴退坡30-50%，进口零部件关税或从5%升至15%，影响毛利率5-8个百分点。

# ## 6. 智能服务机器人行业投资策略：聚焦高壁垒赛道与政策窗口期
# ### 6.1 细分领域机会
# 医疗机器人市场规模突破65亿元（CAGR 40%），商用服务机器人在酒店配送场景渗透率19.3%，工业协作机器人出货量预计增长58%至12.6万台（2024年）。

# ### 6.2 配置时点判断
# 动态PE回落至35倍，重点关注2024Q3世界机器人大会政策催化，战略配置医疗取证、力矩电机国产化、具身智能技术三大主线。
# ## 免责声明
# 本文所涉及内容由AI生成，仅供参考学习使用，不构成具体的投资建议。虽然我们努力确保所用数据的准确性和来源的可靠性，但AI无法完全排除信息错误或遗漏的可能性。投资者应自行验证所有数据的准确性，自主做出投资决策，自行承担投资风险和损失。投资有风险，入市需谨慎。
# '''
#
# print(generator_pic("股票分析", "商汤科技", content))
